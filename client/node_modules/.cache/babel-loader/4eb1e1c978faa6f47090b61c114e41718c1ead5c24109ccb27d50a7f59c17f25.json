{"ast":null,"code":"import _objectSpread from\"D:/tree/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{createContext,useContext,useState,useEffect}from'react';import{GoogleAuthProvider,signInWithPopup,signOut,onAuthStateChanged}from'firebase/auth';import{doc,getDoc,setDoc,serverTimestamp}from'firebase/firestore';import{auth,db,analytics}from'../config/firebase';import{logEvent}from'firebase/analytics';import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(undefined);export const useAuth=()=>{const context=useContext(AuthContext);if(!context){throw new Error('useAuth must be used within an AuthProvider');}return context;};export const AuthProvider=_ref=>{let{children}=_ref;const[currentUser,setCurrentUser]=useState(null);const[userData,setUserData]=useState(null);const[loading,setLoading]=useState(true);// Fetch or create user data in Firestore\nconst fetchOrCreateUserData=async firebaseUser=>{const userRef=doc(db,'users',firebaseUser.uid);const userSnap=await getDoc(userRef);if(userSnap.exists()){// User exists, update last login\nconst userData=userSnap.data();setUserData(userData);return userData;}else{// Create new user\nconst newUser={id:firebaseUser.uid,email:firebaseUser.email,currentAu:0,referralCode:generateReferralCode(),referralMultiplier:1,createdAt:new Date()};await setDoc(userRef,_objectSpread(_objectSpread({},newUser),{},{createdAt:serverTimestamp()}));setUserData(newUser);return newUser;}};useEffect(()=>{const unsubscribe=onAuthStateChanged(auth,async user=>{setCurrentUser(user);if(user){await fetchOrCreateUserData(user);logEvent(analytics,'user_login');}else{setUserData(null);}setLoading(false);});return unsubscribe;},[]);const signInWithGoogle=async()=>{const provider=new GoogleAuthProvider();try{const result=await signInWithPopup(auth,provider);await fetchOrCreateUserData(result.user);logEvent(analytics,'login_success',{method:'google'});}catch(error){console.error('Error signing in with Google:',error);if(error instanceof Error){logEvent(analytics,'login_error',{error:error.message});}throw error;}};const logout=async()=>{try{await signOut(auth);logEvent(analytics,'user_logout');}catch(error){console.error('Error signing out:',error);throw error;}};const generateReferralCode=()=>{return Math.random().toString(36).substring(2,8).toUpperCase();};const value={currentUser,userData,loading,signInWithGoogle,logout};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:!loading&&children});};","map":{"version":3,"names":["React","createContext","useContext","useState","useEffect","GoogleAuthProvider","signInWithPopup","signOut","onAuthStateChanged","doc","getDoc","setDoc","serverTimestamp","auth","db","analytics","logEvent","jsx","_jsx","AuthContext","undefined","useAuth","context","Error","AuthProvider","_ref","children","currentUser","setCurrentUser","userData","setUserData","loading","setLoading","fetchOrCreateUserData","firebaseUser","userRef","uid","userSnap","exists","data","newUser","id","email","currentAu","referralCode","generateReferralCode","referralMultiplier","createdAt","Date","_objectSpread","unsubscribe","user","signInWithGoogle","provider","result","method","error","console","message","logout","Math","random","toString","substring","toUpperCase","value","Provider"],"sources":["D:/tree/client/src/contexts/AuthContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useState, useEffect } from 'react';\r\nimport { \r\n  GoogleAuthProvider, \r\n  signInWithPopup, \r\n  signOut, \r\n  onAuthStateChanged,\r\n  User as FirebaseUser \r\n} from 'firebase/auth';\r\nimport { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore';\r\nimport { auth, db, analytics } from '../config/firebase';\r\nimport { User } from '../types';\r\nimport { logEvent } from 'firebase/analytics';\r\n\r\ninterface AuthContextType {\r\n  currentUser: FirebaseUser | null;\r\n  userData: User | null;\r\n  loading: boolean;\r\n  signInWithGoogle: () => Promise<void>;\r\n  logout: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport const useAuth = () => {\r\n  const context = useContext(AuthContext);\r\n  if (!context) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n};\r\n\r\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const [currentUser, setCurrentUser] = useState<FirebaseUser | null>(null);\r\n  const [userData, setUserData] = useState<User | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  // Fetch or create user data in Firestore\r\n  const fetchOrCreateUserData = async (firebaseUser: FirebaseUser) => {\r\n    const userRef = doc(db, 'users', firebaseUser.uid);\r\n    const userSnap = await getDoc(userRef);\r\n\r\n    if (userSnap.exists()) {\r\n      // User exists, update last login\r\n      const userData = userSnap.data() as User;\r\n      setUserData(userData);\r\n      return userData;\r\n    } else {\r\n      // Create new user\r\n      const newUser: User = {\r\n        id: firebaseUser.uid,\r\n        email: firebaseUser.email!,\r\n        currentAu: 0,\r\n        referralCode: generateReferralCode(),\r\n        referralMultiplier: 1,\r\n        createdAt: new Date()\r\n      };\r\n\r\n      await setDoc(userRef, {\r\n        ...newUser,\r\n        createdAt: serverTimestamp()\r\n      });\r\n\r\n      setUserData(newUser);\r\n      return newUser;\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n      setCurrentUser(user);\r\n      if (user) {\r\n        await fetchOrCreateUserData(user);\r\n        logEvent(analytics, 'user_login');\r\n      } else {\r\n        setUserData(null);\r\n      }\r\n      setLoading(false);\r\n    });\r\n\r\n    return unsubscribe;\r\n  }, []);\r\n\r\n  const signInWithGoogle = async () => {\r\n    const provider = new GoogleAuthProvider();\r\n    try {\r\n      const result = await signInWithPopup(auth, provider);\r\n      await fetchOrCreateUserData(result.user);\r\n      logEvent(analytics, 'login_success', {\r\n        method: 'google'\r\n      });\r\n    } catch (error) {\r\n      console.error('Error signing in with Google:', error);\r\n      if (error instanceof Error) {\r\n        logEvent(analytics, 'login_error', {\r\n          error: error.message\r\n        });\r\n      }\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const logout = async () => {\r\n    try {\r\n      await signOut(auth);\r\n      logEvent(analytics, 'user_logout');\r\n    } catch (error) {\r\n      console.error('Error signing out:', error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  const generateReferralCode = () => {\r\n    return Math.random().toString(36).substring(2, 8).toUpperCase();\r\n  };\r\n\r\n  const value = {\r\n    currentUser,\r\n    userData,\r\n    loading,\r\n    signInWithGoogle,\r\n    logout\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>\r\n      {!loading && children}\r\n    </AuthContext.Provider>\r\n  );\r\n}; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}